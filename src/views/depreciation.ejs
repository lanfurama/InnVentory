<%- include('./partials/header') %>
<%- include('./partials/nav') %>
        <%- include('./partials/breadcrumb', { items: [
          { label: typeof t !== 'undefined' ? t('breadcrumb.home') : 'Home', url: '/' },
          { label: typeof t !== 'undefined' ? t('breadcrumb.assets') : 'Assets', url: '/assets' },
          { label: typeof t !== 'undefined' ? t('breadcrumb.depreciationCalculation') : 'Depreciation Calculation' }
        ] }) %>
        <div class="page-header-flex">
          <div>
            <h1 class="page-title"><%= typeof t !== 'undefined' ? t('depreciation.managementTitle') : 'Depreciation Management' %></h1>
            <p class="text-muted mb-0 mt-1" style="font-size: 0.9rem;"><%= typeof t !== 'undefined' ? t('depreciation.managementDesc') : 'Configure parameters to generate new depreciation schedules for the upcoming fiscal period.' %></p>
          </div>
          <div class="page-header-actions">
            <button type="button" class="btn btn-primary btn-primary-rounded" onclick="window.print();"><i class="fas fa-file-download mr-1"></i> <%= typeof t !== 'undefined' ? t('depreciation.exportReport') : 'Export Report' %></button>
            <a class="nav-link d-inline-block" href="#" title="<%= typeof t !== 'undefined' ? t('nav.notifications') : 'Notifications' %>"><i class="fas fa-bell"></i></a>
            <a class="nav-link d-inline-block" href="#" title="<%= typeof t !== 'undefined' ? t('nav.help') : 'Help' %>"><i class="fas fa-question-circle"></i></a>
          </div>
        </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <section class="content">
      <div class="container-fluid">
        <% if(typeof errors != 'undefined' && errors.length) { %>
        <div class="alert alert-danger alert-dismissible">
          <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
          <% errors.forEach(err => { %><%= err.msg %><br><% }) %>
        </div>
        <% } %>
        <% if(typeof success !== 'undefined' && success) { %>
        <div class="alert alert-success alert-dismissible">
          <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
          <%= typeof t !== 'undefined' ? t('depreciation.calcSuccess') : 'Depreciation calculated successfully.' %>
        </div>
        <% } %>

        <div class="row">
          <div class="col-lg-5">
            <div class="card chart-card filter-section">
              <div class="card-header">
                <h3 class="card-title mb-0"><i class="fas fa-cog mr-1"></i> <%= typeof t !== 'undefined' ? t('depreciation.configuration') : 'Configuration' %></h3>
              </div>
              <div class="card-body">
                <form action="/depreciation/calculate" method="post">
                  <div class="form-group">
                    <label><%= typeof t !== 'undefined' ? t('depreciation.depreciationMethod') : 'Depreciation Method' %></label>
                    <select class="form-control" disabled>
                      <option><%= typeof t !== 'undefined' ? t('depreciation.straightLine') : 'Straight Line' %></option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label><%= typeof t !== 'undefined' ? t('depreciation.fiscalPeriod') : 'Fiscal Period' %></label>
                    <input type="text" class="form-control" value="FY <%= new Date().getFullYear() %> (Current)" readonly />
                  </div>
                  <div class="form-group">
                    <label><%= typeof t !== 'undefined' ? t('depreciation.startingDate') : 'Starting Date' %></label>
                    <input type="date" name="period_start" class="form-control" required value="<%= formData && formData.period_start ? formData.period_start : '' %>" />
                  </div>
                  <div class="form-group">
                    <label><%= typeof t !== 'undefined' ? t('depreciation.calculateUpto') : 'Calculate upto' %></label>
                    <input type="date" name="period_end" class="form-control" required value="<%= formData && formData.period_end ? formData.period_end : '' %>" />
                  </div>
                  <div class="form-group">
                    <label><%= typeof t !== 'undefined' ? t('depreciation.salvageValueAdjustment') : 'Salvage Value Adjustment ($)' %></label>
                    <input type="number" name="salvage_adjustment" class="form-control" step="0.01" min="0" value="<%= formData && formData.salvage_adjustment != null ? formData.salvage_adjustment : '0.00' %>" placeholder="0.00" />
                  </div>
                  <div class="form-group">
                    <label><%= typeof t !== 'undefined' ? t('depreciation.referenceNumber') : 'Reference Number' %></label>
                    <input type="text" name="reference_number" class="form-control" value="<%= formData && formData.reference_number ? formData.reference_number : '' %>" />
                  </div>
                  <div class="form-group">
                    <div class="custom-control custom-checkbox">
                      <input type="checkbox" class="custom-control-input" id="revaluate" name="revaluate" value="1" <%= formData && formData.revaluate ? 'checked' : '' %> />
                      <label class="custom-control-label" for="revaluate"><%= typeof t !== 'undefined' ? t('depreciation.revaluate') : 'Revaluate Asset for Calculation' %></label>
                    </div>
                  </div>
                  <% if(typeof locals.user != 'undefined') { %>
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-calculator"></i> <%= typeof t !== 'undefined' ? t('depreciation.calculate') : 'Calculate Depreciation' %>
                  </button>
                  <% } %>
                </form>
              </div>
            </div>

            <div class="dashboard-metrics-row">
              <div class="metric-card flex-fill">
                <div class="metric-icon bg-blue">
                  <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="metric-content">
                  <div class="metric-label"><%= typeof t !== 'undefined' ? t('depreciation.totalAssets') : 'TOTAL ASSETS' %></div>
                  <div class="metric-value">$<%= typeof totalValue !== 'undefined' && totalValue ? (totalValue >= 1000000 ? (totalValue / 1000000).toFixed(1) + 'M' : Number(totalValue).toLocaleString()) : '0' %></div>
                  <div class="metric-trend positive"><i class="fas fa-arrow-up"></i> +12% YoY</div>
                </div>
              </div>
              <div class="metric-card flex-fill">
                <div class="metric-icon bg-orange">
                  <i class="fas fa-chart-line"></i>
                </div>
                <div class="metric-content">
                  <div class="metric-label"><%= typeof t !== 'undefined' ? t('depreciation.estExpense') : 'EST. EXPENSE' %></div>
                  <div class="metric-value">$<%= typeof estExpenseFY !== 'undefined' && estExpenseFY ? (estExpenseFY >= 1000 ? (estExpenseFY / 1000).toFixed(0) + 'k' : Number(estExpenseFY).toLocaleString()) : '0' %></div>
                  <div class="metric-trend neutral"><%= typeof t !== 'undefined' ? t('depreciation.forFY') : 'For FY' %> <%= new Date().getFullYear() %></div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-7">
            <div class="chart-card">
              <h3 class="chart-title"><%= typeof t !== 'undefined' ? t('depreciation.bookValueProjection') : 'Book Value Projection' %></h3>
              <div class="chart-subtitle"><%= typeof t !== 'undefined' ? t('depreciation.bookValueProjectionSub') : 'Projected asset value depreciation over the next 10 years.' %></div>
              <div class="chart-legend-radio mb-3">
                <label class="chart-legend-option mr-3">
                  <input type="radio" name="bookValueLegend" value="net" checked>
                  <span class="chart-legend-dot" style="background:#1976d2"></span>
                  <%= typeof t !== 'undefined' ? t('depreciation.netBookValue') : 'Net Book Value' %>
                </label>
                <label class="chart-legend-option">
                  <input type="radio" name="bookValueLegend" value="original">
                  <span class="chart-legend-dot" style="background:#95a5a6"></span>
                  <%= typeof t !== 'undefined' ? t('depreciation.originalCost') : 'Original Cost' %>
                </label>
              </div>
              <div id="bookValueProjectionChart" style="min-height: 320px;"></div>
            </div>
          </div>
        </div>

        <div class="card mt-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0"><%= typeof t !== 'undefined' ? t('depreciation.calculationHistory') : 'Calculation History' %></h3>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table id="historyTable" class="table table-hover mb-0 enhanced-table">
                <thead>
                  <tr>
                    <th>No</th>
                    <th><%= typeof t !== 'undefined' ? t('depreciation.periodStart') : 'Period Start' %></th>
                    <th><%= typeof t !== 'undefined' ? t('depreciation.periodEnd') : 'Period End' %></th>
                    <th><%= typeof t !== 'undefined' ? t('depreciation.referenceNumber') : 'Reference' %></th>
                    <th><%= typeof t !== 'undefined' ? t('depreciation.createdAt') : 'Created At' %></th>
                    <th><%= typeof t !== 'undefined' ? t('common.action') : 'Action' %></th>
                  </tr>
                </thead>
                <tbody>
                  <% (calculationRuns || []).forEach((run, i) => { %>
                  <tr>
                    <td><%= i + 1 %></td>
                    <td><%= run.period_start ? run.period_start.toString().slice(0, 10) : '-' %></td>
                    <td><%= run.period_end ? run.period_end.toString().slice(0, 10) : '-' %></td>
                    <td><%= run.reference_number || '-' %></td>
                    <td><%= run.created_at ? new Date(run.created_at).toLocaleString() : '-' %></td>
                    <td>
                      <a href="/depreciation/show/<%= run.id %>" class="btn btn-info btn-sm"><i class="fas fa-eye"></i> <%= typeof t !== 'undefined' ? t('depreciation.show') : 'Show' %></a>
                      <% if(typeof locals.user != 'undefined') { %>
                      <form action="/depreciation/remove/<%= run.id %>" method="post" class="d-inline" onsubmit="return confirm('<%= typeof t !== 'undefined' ? t('depreciation.confirmRemove') : 'Are you sure you want to remove this calculation entry?' %>');">
                        <button type="submit" class="btn btn-danger btn-sm"><i class="fas fa-trash-alt"></i> <%= typeof t !== 'undefined' ? t('depreciation.remove') : 'Remove' %></button>
                      </form>
                      <% } %>
                    </td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

<script>
(function() {
  var bookValueProjection = <%- JSON.stringify(typeof bookValueProjection !== 'undefined' ? bookValueProjection : { years: [], netBookValues: [], originalCosts: [] }) %>;
  if (bookValueProjection.years && bookValueProjection.years.length) {
    window.depreciationChartConfig = {
      bookValueProjection: {
        containerId: 'bookValueProjectionChart',
        years: bookValueProjection.years,
        netBookValues: bookValueProjection.netBookValues,
        originalCosts: bookValueProjection.originalCosts
      }
    };
  }
})();
</script>
<%- include('./partials/footer') %>
